<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Your Dashboard</h2>
            <a href="profile.html" style="font-weight: 600; text-decoration: none;">My Profile</a>
        </div>
        <p style="margin-top: 0; color: #65676b;">Welcome! Here are your modules:</p>
        
        <div id="content-cbse-10" class="content-group" style="display: none;">
            
            <h2 class="subject-header">Science</h2>
            <div class="module-grid">
                <a href="modules/cbse/grade10/science/nacl-reaction/index.html" class="module-card" id="module-nacl-reaction">
                    <div class="module-card-image img-science">Science</div>
                    <div class="module-card-content">
                        <h3>The Na + Cl Reaction</h3>
                        <div class="module-card-progress">
                            <span class="icon">○</span>
                            <span class="status-text">Not Started</span>
                        </div>
                    </div>
                </a>

                <a href="modules/cbse/grade10/science/gravity/index.html" class="module-card" id="module-gravity">
                    <div class="module-card-image img-science">Science</div>
                    <div class="module-card-content">
                        <h3>Understanding Gravity</h3>
                        <div class="module-card-progress">
                            <span class="icon">○</span>
                            <span class="status-text">Not Started</span>
                        </div>
                    </div>
                </a>

                <a href="modules/cbse/grade10/science/light/index.html" class="module-card" id="module-light-reflection">
                    <div class="module-card-image img-science">Science</div>
                    <div class="module-card-content">
                        <h3>Light</h3>
                        <div class="module-card-progress">
                            <span class="icon">○</span>
                            <span class="status-text">Not Started</span>
                        </div>
                    </div>
                </a>
            </div> <h2 class="subject-header">History</h2>
            <div class="module-grid">
                <a href="modules/cbse/grade10/history/french-revolution/index.html" class="module-card" id="module-french-revolution">
                    <div class="module-card-image img-history">History</div>
                    <div class="module-card-content">
                        <h3>The French Revolution</h3>
                        <div class="module-card-progress">
                            <span class="icon">○</span>
                            <span class="status-text">Not Started</span>
                        </div>
                    </div>
                </a>
            </div> </div> <p id="no-content-message" style="display: none;">
            Content for your board and grade is coming soon!
        </p>
        
        <br>
        <button id="logoutButton" style="margin-top: 20px; max-width: 120px; float: right;">Logout</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    
    <script>
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);


        // --- LOGOUT SCRIPT ---
        document.getElementById('logoutButton').addEventListener('click', async () => {
            await _supabase.auth.signOut();
            window.location.href = 'index.html';
        });


        // --- DASHBOARD LOADING LOGIC ---
        async function loadDashboard() {
            // 1. Get the user
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // 2. Get the user's profile
            const { data: profile, error: profileError } = await _supabase
                .from('profiles')
                .select('board, grade')
                .eq('id', user.id)
                .single();

            if (profileError || !profile) {
                console.error('Error fetching profile:', profileError);
                document.getElementById('no-content-message').style.display = 'block';
                return;
            }

            // 3. Build and show the correct content div
            const contentId = `content-${profile.board}-${profile.grade}`;
            const contentDiv = document.getElementById(contentId);
            
            if (contentDiv) {
                contentDiv.style.display = 'block';
                // 4. Load progress *after* content is visible
                loadUserProgress(user.id);
            } else {
                document.getElementById('no-content-message').style.display = 'block';
            }
        }
        
        /*
         * We DELETED the setupCollapsibles() function.
         * It's not needed anymore!
         */

        /**
         * UPDATED loadUserProgress function
         * This now adds a class to the card instead of an emoji.
         */
        async function loadUserProgress(userId) {
            const { data: progress, error } = await _supabase
                .from('user_progress')
                .select('module_name')
                .eq('user_id', userId);

            if (error || !progress) return; 

            const completedModules = progress.map(item => item.module_name);

            // Check for 'nacl-reaction'
            if (completedModules.includes('nacl-reaction')) {
                updateCard('module-nacl-reaction');
            }
            
            // Check for 'gravity'
            if (completedModules.includes('gravity')) {
                updateCard('module-gravity');
            }

            // Check for 'french-revolution'
            if (completedModules.includes('french-revolution')) {
                updateCard('module-french-revolution');
            }

            // Check for 'light'
            if (completedModules.includes('light-reflection')) {
                updateCard('module-light-reflection');
            }
        }

        /**
         * Helper function to update a card's UI to "Completed"
         */
        function updateCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            card.classList.add('completed'); // This triggers the CSS
            const icon = card.querySelector('.icon');
            const statusText = card.querySelector('.status-text');

            if (icon) icon.textContent = '✅';
            if (statusText) statusText.textContent = 'Completed';
        }

        // --- RUN EVERYTHING ON PAGE LOAD ---
        loadDashboard();
    </script>
</body>
</html>